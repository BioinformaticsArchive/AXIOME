#!/bin/bash

(head -n 2 "$1"; awk -F '\t' 'NR > 2 {s = 0; for (i = 2; i < NF; i++) { s += $i; } print s, $0; }' "$1" | sort -nr | head -n "$2" ) | awk -F '\t' 'NR == 2 { for (i = 2; i < NF; i++) { name[i] = $i; } } NR > 2 { for (i = 2; i < NF; i++) { v[i] = v[i] "," $i } id = id "," substr($1, index($1, " ") + 1); } END { printf("%d,samples", length(name)); for (i = 4; i < NR; i++) { printf(","); } printf("\n"); printf("%d,OTUs", (NR - 2)); for (i = 4; i < NR; i++) { printf(","); } printf("\n"); for (i = 2; i < NR; i++) { printf(",Q"); } printf("\n"); print id; for (x in name) { print name[x], v[x]; } }'
