#!/usr/bin/env Rscript
# Copyright 2011
#  Xingpeng Jiang <xingpengjiang@gmail.com>
#  Jonathan Dushoff <dushoff@mcmaster.ca>
#  Andre Masella <andre@masella.name>
options(error = quote(dump.frames("nmf-concordance-debug", TRUE)))

kstart <- 2  # start rank
nloop <- 100  # runs for each rank
nmf.method <- "brunet" # NMF method

source("@prefix@/share/@PACKAGE@/nmf.R")
source("@prefix@/share/@PACKAGE@/biom.R")

#Pull in arguments
args <- commandArgs(trailingOnly = TRUE)

#Search within args for the biom flags
isBiomFile <- TRUE %in% (c("-B","-b","--biom", "--BIOM") %in% args)

#Clear out any flags from the command arguments
args <-args[ (args != "-b" & args != "-B" & args != "--biom" & args != "--BIOM") ]

#Read in and format otu table
print("Reading OTU table")
if ( isBiomFile ) {
        otutable <- BIOM2table("otu_table.txt")
} else {
        rawtable <- read.table("otu_table.txt", skip = 1,
        comment.char = "", header = TRUE, row.names = 1, sep = "\t")
        otutable <- t(rawtable[1:(ncol(rawtable) - 1)])
}

kend <- ncol(otutable) - 1   # end rank
print("Computing")
z <- apply(as.matrix(t(otutable)), 2, function(x) { x/sum(x) })
ad <- ConsensusFuzzyH(z, nmf.method = nmf.method, Rnmf = FALSE, kstart, kend, nloop, method = "square", ifseed = FALSE)

print("Plotting")
pdf("nmf-concordance.pdf")
print(ad$averdiff)
plot(kstart:kend, ad$averdiff, type = "l", xlab = "Degree", ylab = "Concordance")
points(kstart:kend, ad$averdiff, pch = 16)
